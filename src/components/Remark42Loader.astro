---
import siteConfig from '~/site.config'

const r = siteConfig.remark42
if (!r) {
  throw new Error('Remark42 configuration is missing in site.config.ts')
}
const host = r.host
const siteId = r.site_id
const components = r.components && r.components.length > 0 ? r.components : ['embed']
const componentName = components[0]
const locale = r.locale || 'tr'
const remarkConfigJson = JSON.stringify({ host, site_id: siteId, components })
const embedMjs = `${host}/web/${componentName}.mjs`
const embedJs = `${host}/web/${componentName}.js`
---

<!-- 3) Yorumların görüneceği yer -->
<div id="remark42" data-host={host} data-site-id={siteId} data-components={JSON.stringify(components)} data-locale={locale}></div>

<!-- 1) Global config + 2) Loader (JS üzerinden eklenir) -->
<script is:inline>
  (function(){
    var el = document.getElementById('remark42')
    if (!el) return
    var host = el.getAttribute('data-host') || ''
    var site_id = el.getAttribute('data-site-id') || ''
    var componentsAttr = el.getAttribute('data-components') || '[]'
    var locale = el.getAttribute('data-locale') || 'tr'
    var components
    try { components = JSON.parse(componentsAttr) } catch (e) { components = ['embed'] }
    if (!Array.isArray(components) || components.length === 0) components = ['embed']
    var name = components[0] || 'embed'

    function mapTheme(t){
      if (!t) return 'light'
      t = String(t).toLowerCase()
      return t.indexOf('dark') !== -1 ? 'dark' : 'light'
    }

    var customCssUrl = (function(){
      try {
        return new URL('/remark42-overrides.css', window.location.origin).href
      } catch (e) {
        return (window.location.origin || '') + '/remark42-overrides.css'
      }
    })()

    var appliedTheme = null

    function setThemeAttribute(theme) {
      if (!el) return
      try {
        el.setAttribute('data-remark42-theme', theme)
      } catch (e) {}
    }

    function injectScripts(theme){
      // 1) Global config with theme
      var remark_config = {
        host: host,
        site_id: site_id,
        components: components,
        theme: theme,
        locale: locale,
        customCss: customCssUrl,
      }
      window.remark_config = remark_config
      setThemeAttribute(theme)
      appliedTheme = theme

      // Destroy previous render if API exists to avoid ghost nodes
      try {
        if (window.REMARK42 && typeof window.REMARK42.destroy === 'function') {
          window.REMARK42.destroy()
        }
      } catch (e) {}

      // Clear previous render if any
      try { el.innerHTML = '' } catch(e) {}

      // Remove previously injected remark scripts (best-effort)
      var head = document.head || document.body
      var prev = head.querySelectorAll('script[data-remark42]')
      prev.forEach(function(p){ p.parentNode && p.parentNode.removeChild(p) })

      // 2) Loader scripts
      var m = document.createElement('script')
      m.type = 'module'; m.defer = true; m.async = true
      m.src = host + '/web/' + name + '.mjs'
      m.setAttribute('data-remark42','')
      head.appendChild(m)

      var n = document.createElement('script')
      n.setAttribute('nomodule',''); n.defer = true; n.async = true
      n.src = host + '/web/' + name + '.js'
      n.setAttribute('data-remark42','')
      head.appendChild(n)
    }

    function applyTheme(theme) {
      if (!theme || theme === appliedTheme) return

      if (window.REMARK42 && typeof window.REMARK42.changeTheme === 'function') {
        try {
          window.REMARK42.changeTheme(theme)
          setThemeAttribute(theme)
          appliedTheme = theme
          return
        } catch (e) {
          // fall through to reinject on error
        }
      }

      injectScripts(theme)
    }

    // Initial theme from page
    var currentTheme = document.documentElement.getAttribute('data-theme')
    injectScripts(mapTheme(currentTheme))

    // Observe theme changes and re-inject
    try {
      var obs = new MutationObserver(function(mutations){
        for (var i=0; i<mutations.length; i++){
          var mu = mutations[i]
          if (mu.type === 'attributes' && mu.attributeName === 'data-theme'){
            var t = document.documentElement.getAttribute('data-theme')
            applyTheme(mapTheme(t))
            break
          }
        }
      })
      obs.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] })
    } catch(e) {}
  })();
  // Türkçe: Sadece bu iki değeri değiştireceksin: host ve site_id
  // Tema, sayfadaki data-theme değerine göre otomatik olarak 'light'/'dark' ayarlanır.
</script>
